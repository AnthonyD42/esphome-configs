# Light dimmer
# https://devices.esphome.io/devices/MJ-SJ01

# GPI Mappings
# GPIO0 - Up button (input, pullup, inverted)
# GPIO1 - Down button (input, pullup, inverted)
# GPIO3 - LED 5 (output, inverted)
# GPIO4 - Status LED Red (output, inverted)
# GPIO5 - LED 4 (output, inverted)
# GPIO12 - LED 3 (output, inverted)
# GPIO13 - PWM output to dimmer (output, esp8266_pwm)
# GPIO14 - LED 2 (output, inverted)
# GPIO15 - Main button (input, pullup)
# GPIO16 - Relay control (output, inverted)

# https://esphome.io/guides/configuration-types.html#substitutions
substitutions:
  project: Using MJ-SD01 Dimmer 02 to control iFan03
  location: Office
  device_name: mj_sd01_dimmer_02 # hostname & entity_id
  friendly_name: MJ-SD01 Dimmer 02 # Displayed in HA frontend

# https://esphome.io/components/esphome
esphome:
  device_name: ${device_name}
  name_add_mac_suffix: false
  friendly_name: ${friendly_name}

# https://esphome.io/components/esp8266.html  
esp8266:
  board: esp01_1m

# https://esphome.io/components/api
api:
  encryption:
    key: !secret api_encryption_key

# https://esphome.io/components/ota
ota:
  - platform: esphome
    password: !secret ota_password

# https://esphome.io/components/wifi
wifi:  
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  ap:
    ssid: ${friendly_name} AP
    password: !secret ap_password

captive_portal:

# https://esphome.io/components/web_server.html
web_server:
  # port: 80
  # Can cause high memory usage on ESP8266, enable as needed

# https://esphome.io/components/logger
logger:

sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

binary_sensor:
  - platform: gpio
    pin: GPIO15
    name: "Main Button"
    on_press:
      - homeassistant.service:
          service: light.toggle
          data:
            entity_id: light.sonoff_ifan03_01_light

  - platform: gpio
    pin: GPIO0
    name: "Up Button"
    on_press:
      - homeassistant.service:
          service: fan.increase_speed
          data:
            entity_id: fan.sonoff_ifan03_01_fan

  - platform: gpio
    pin: GPIO1
    name: "Down Button"
    on_press:
      - homeassistant.service:
          service: fan.decrease_speed
          data:
            entity_id: fan.sonoff_ifan03_01_fan

output:
  - platform: gpio
    pin: GPIO4
    id: red_led
  - platform: gpio
    pin: GPIO16
    id: relay_led
  - platform: gpio
    pin: GPIO14
    id: led2
  - platform: gpio
    pin: GPIO12
    id: led3
  - platform: gpio
    pin: GPIO5
    id: led4
  - platform: gpio
    pin: GPIO3
    id: led5

script:
  cycle_fan_speed:
    sequence:
      - service: fan.set_percentage
        target:
          entity_id: fan.sonoff_ifan03_01_fan
        data_template:
          percentage: >
            {% set speed = state_attr('fan.sonoff_ifan03_01_fan', 'percentage') | int %}
            {% if speed == 0 %} 33
            {% elif speed == 33 %} 66
            {% elif speed == 66 %} 100
            {% else %} 0
            {% endif %}